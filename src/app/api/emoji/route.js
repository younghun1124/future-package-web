import { NextResponse } from 'next/server';
import { Mistral } from "@mistralai/mistralai";

// Mistral AI ì´ˆê¸°í™”
const mistral = new Mistral({
  apiKey: process.env.MISTRAL_API_KEY ?? "",
});

export async function POST(request) {
  try {
    const { text } = await request.json();

    if (!text) {
      return NextResponse.json(
        { error: 'ë³€í™˜í•  í…ìŠ¤íŠ¸ê°€ í•„ìš”í•©ë‹ˆë‹¤.' },
        { status: 400 }
      );
    }

    if (text.length > 50 || text.length < 1) {
      return NextResponse.json(
        { error: 'í…ìŠ¤íŠ¸ëŠ” 1-50ìž ì‚¬ì´ì—¬ì•¼ í•©ë‹ˆë‹¤.' },
        { status: 400 }
      );
    }

    const prompt = `
    ë‹¹ì‹ ì€ ì´ëª¨ì§€ ë³€í™˜ê¸°ìž…ë‹ˆë‹¤.
    ì‚¬ìš©ìžê°€ ìž…ë ¥í•œ ë‹¨ì–´ë‚˜ ë¬¸ìž¥ì„ ì´ëª¨ì§€ë¡œ ë³€í™˜í•´ì£¼ì„¸ìš”.
    
    ì‚¬ìš©ìžê°€ ìž…ë ¥í•œ ë¬¸ìž¥: "${text}"

    ê·œì¹™:
    1. ê° ê¸€ìžë¥¼ ê°€ìž¥ ì ì ˆí•œ ì´ëª¨ì§€ë¡œ ë³€í™˜. ê¸°ë³¸ì ìœ¼ë¡œ ì´ëª¨ì§€ë¡œ ë³€í™˜í•  ë•Œ ë‹¨ì–´ ì˜ë¯¸ ë‹¨ìœ„ë¡œ ì´ëª¨ì§€ ë³€í™˜í•´ì¤˜.
    2. ì§ê´€ì ì´ê³  ì¶”ì¸¡ ê°€ëŠ¥í•œ ì´ëª¨ì§€ ì‚¬ìš©
    3. ì‘ë‹µì—ëŠ” ë°˜ë“œì‹œ ì´ëª¨ì§€ë§Œ í¬í•¨ë˜ì–´ì•¼ í•¨
    4. ìµœëŒ€ 20ê°œ ì´ëª¨ì§€ê¹Œì§€ë§Œ ì‚¬ìš©
    5. ìˆ«ìž, ë¬¸ìž, íŠ¹ìˆ˜ë¬¸ìž ë“± ì´ëª¨ì§€ê°€ ì•„ë‹Œ ê²ƒì€ ì ˆëŒ€ í¬í•¨í•˜ë©´ ì•ˆ ë¨
    6. ì˜ˆì‹œë¥¼ ì°¸ê³ í•˜ì—¬ ë³€í™˜ ê²°ê³¼ë¥¼ ìƒì„±
    
    ì°¸ê³  ì˜ˆì‹œ1:
    ì‚¬ìš©ìž ìž…ë ¥: ìƒˆí•´ ë³µ ë§Žì´ ë°›ìœ¼ì„¸ìš”
    ë³€í™˜ ê²°ê³¼: ðŸŽ‰ðŸ§§ðŸ’¯ðŸ¤²

    ì°¸ê³  ì˜ˆì‹œ2:
    ì‚¬ìš©ìž ìž…ë ¥: ì†Œë…€ëŠ” ê³µì› êµ¬ì„ì— ë¶ˆìŒí•˜ê²Œ ì­ˆê·¸ë¦¬ê³  ì•‰ì•„ ë‚˜ë­‡ê°€ì§€ë¡œ ëª¨ëž˜ì— ë‚™ì„œë¥¼ í•˜ê³  ìžˆì—ˆë‹¤.
    ë³€í™˜ ê²°ê³¼: ðŸ‘§ðŸ»ðŸžï¸ðŸŒ³ðŸ˜”ðŸ’ºðŸŒ¿âœï¸ðŸ–ï¸

    ì°¸ê³  ì˜ˆì‹œ3:
    ì‚¬ìš©ìž ìž…ë ¥: ë¯¸ì•ˆí•´ ë‚´ê°€ ë„ˆë¥¼ ìƒê° ì•ˆí•˜ê³  ë„ˆë¬´ ì§ì§„ë§Œ í–ˆì§€? ì´ì œ ì²œì²œížˆ ë‹¤ê°€ê°ˆê»˜ ë¯¸ì•ˆí•´
    ë³€í™˜ ê²°ê³¼: ðŸ™ðŸ»ðŸ’­ðŸ‘€ðŸ˜”ðŸ’”ðŸ˜¢ðŸ™ðŸ»ðŸ•°ï¸ðŸ’¨ðŸ˜Š

    ì°¸ê³  ì˜ˆì‹œ4:
    ì‚¬ìš©ìž ìž…ë ¥: ë©”ë¦¬ í¬ë¦¬ìŠ¤ë§ˆìŠ¤!! í–‰ë³µí•œ í•˜ë£¨ ë˜ê¸¸ ë°”ëž˜ ì´ë²ˆ ë…„ë„ë„ ìˆ˜ê³ í–ˆê³  ë‚´ë…„ë„ íŒŒì´íŒ… í•´ë³´ìž
    ë³€í™˜ ê²°ê³¼: ðŸŽ„ðŸŽ…ï¸!! ðŸ˜ŠðŸ™ ðŸ’ªðŸ¼ðŸŽ‰ ðŸ‘ðŸ˜Š ðŸŽŠðŸ”¥ðŸ’¥
    `;

    const result = await mistral.chat.complete({
      model: "mistral-large-latest",
      stream: false,
      messages: [
        {
          role: "user",
          content: prompt
        }
      ]
    });

    const emojiResult = result.choices[0].message.content.trim();

    return NextResponse.json({ 
      success: true,
      text: text,
      emoji: emojiResult 
    });

  } catch (error) {
    console.error('ì´ëª¨ì§€ ë³€í™˜ ì¤‘ ì˜¤ë¥˜ ë°œìƒ:', error);
    return NextResponse.json(
      { error: 'ì´ëª¨ì§€ ë³€í™˜ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.' },
      { status: 500 }
    );
  }
} 